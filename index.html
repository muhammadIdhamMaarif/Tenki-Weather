<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!--
      Tenki Custom WebGL Template for Unity 6 (6000.2.3f1)
      -----------------------------------------------------      
    -->
    <title>Tenki Weather</title>
    <style>
        :root {
            /* Page brand color */
            --page-bg: #E3FBFF; /* light blue */
            --text: #0b0f1a;
            --muted: rgba(0,0,0,.55);
            --accent: #0ea5e9;
            --accent-2: #38bdf8;
            --track: rgba(0,0,0,.08);
            --radius: 14px;
        }

        html, body { height: 100%; }
        html { background: var(--page-bg); }
        body {
            margin: 0; height: 100%; display: grid; place-items: center; color: var(--text);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;
            /* Custom cursor (provide both png and cur/ani for broad support) */
            cursor: url('TemplateAssets/cursor/cursor.png') 0 0, url('TemplateAssets/cursor/cursor.cur'), auto;
        }

        /* Layout */
        .wrap { width: min(920px, 92vw); margin: 0 auto; }
        .preload {
            display: grid; grid-template-columns: 180px 1fr; gap: 24px; align-items: center;
            background: rgba(255,255,255,.65); padding: 24px; border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(2, 6, 23, .08), 0 2px 6px rgba(2,6,23,.06);
            backdrop-filter: blur(6px);
        }
        @media (max-width: 640px) {
            .preload { grid-template-columns: 1fr; gap: 14px; text-align: center; }
        }

        .brand { font-weight: 700; font-size: 1.1rem; letter-spacing: .2px; }
        .small { color: var(--muted); font-size: .94rem; }

        /* Sprite area */
        .sprite-box {
            width: 180px; height: 180px; border-radius: 16px; overflow: hidden;
            display: grid; place-items: center; background: rgba(255,255,255,.8);
            border: 1px solid rgba(2,6,23,.06);
        }
        .sprite-box img { width: 100%; height: 100%; object-fit: contain; image-rendering: auto; }

        /* Slider progress (using native input[type=range]) */
        .progress { display: grid; gap: 10px; }
        .pct { font-variant-numeric: tabular-nums; font-weight: 600; }

        input[type=range] {
            -webkit-appearance: none; appearance: none; width: 100%; height: 12px;
            background: var(--track); border-radius: 999px; outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 26px; height: 26px; border-radius: 50%;
            background: linear-gradient(180deg, var(--accent), var(--accent-2)); box-shadow: 0 2px 6px rgba(0,0,0,.2);
            border: none; margin-top: -7px; /* align thumb vertically */
        }
        input[type=range]::-moz-range-thumb {
            width: 26px; height: 26px; border-radius: 50%; border: none;
            background: linear-gradient(180deg, var(--accent), var(--accent-2)); box-shadow: 0 2px 6px rgba(0,0,0,.2);
        }
        input[type=range]::-webkit-slider-runnable-track { height: 12px; border-radius: 999px; }
        input[type=range]::-moz-range-track { height: 12px; border-radius: 999px; background: transparent; }

        /* Canvas hidden until load complete */
        #unity-canvas { display: none; width: 100vw; height: 100vh; outline: none; background: var(--page-bg); }

        /* Link & misc */
        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
<!-- PRELOADER -->
<div class="wrap" id="preload">
    <div class="preload">
        <div class="sprite-box">
            <!-- Replace Unity logo with your animated sprite -->
            <img id="sprite" alt="Loading animation" src="TemplateAssets/sprite/placeholder.png" />
        </div>
        <div class="progress">
            <div class="brand">Tenki Weather</div>
            <div class="small" id="status">Initializing…</div>
            <input id="slider" type="range" min="0" max="100" value="0" disabled />
            <div class="small"><span class="pct" id="pct">0%</span> loading</div>
        </div>
    </div>
</div>

<!-- GAME CANVAS -->
<canvas id="unity-canvas" tabindex="0"></canvas>

<script>
    // ====== CONFIGURABLE SPRITE SETTINGS ======
    // Place frames under TemplateAssets/sprite/ following this naming pattern.
    // You can tweak these defaults from the template by editing the values below.
    const SPRITE_PATH = 'TemplateAssets/sprite/';
    const SPRITE_PREFIX = 'run_';       // e.g., run_0001.png
    const SPRITE_DIGITS = 4;            // zero-padding length
    const SPRITE_EXT = 'png';
    const SPRITE_FRAMES = 8;           // total number of frames
    const SPRITE_FPS = 8;              // playback speed

    // ====== UNITY BUILD SETTINGS (injected by Unity) ======
    const buildUrl = 'Build';
    const loaderUrl = buildUrl + '/Tenki-Weather.loader.js';
    const config = {
        dataUrl: buildUrl + '/Tenki-Weather.data',
        frameworkUrl: buildUrl + '/Tenki-Weather.framework.js',
        codeUrl: buildUrl + '/Tenki-Weather.wasm',
        memoryUrl: buildUrl + '/',
        symbolsUrl: buildUrl + '/',
        companyName: 'Estella',
        productName: 'Tenki Weather',
        productVersion: '0.1.0'
    };

    // ====== SPRITE ANIMATION LOADER ======
    const spriteImg = document.getElementById('sprite');
    const slider = document.getElementById('slider');
    const pctEl = document.getElementById('pct');
    const statusEl = document.getElementById('status');
    const preload = document.getElementById('preload');
    const canvas = document.getElementById('unity-canvas');

    function pad(num, size) { let s = String(num); while (s.length < size) s = '0' + s; return s; }

    // Preload all frames (simple approach)
    const frames = new Array(SPRITE_FRAMES).fill(0).map((_, i) => {
        const img = new Image();
        img.src = `${SPRITE_PATH}${SPRITE_PREFIX}${pad(i+1, SPRITE_DIGITS)}.${SPRITE_EXT}`;
        return img;
    });

    let frameIndex = 0;
    let lastTime = 0;
    const frameTime = 1000 / SPRITE_FPS;

    function animateSprite(ts) {
        if (!lastTime) lastTime = ts;
        const delta = ts - lastTime;
        if (delta >= frameTime) {
            frameIndex = (frameIndex + 1) % frames.length;
            spriteImg.src = frames[frameIndex].src;
            lastTime = ts;
        }
        requestAnimationFrame(animateSprite);
    }
    requestAnimationFrame(animateSprite);

    // ====== LOAD UNITY LOADER AND CREATE INSTANCE ======
    const script = document.createElement('script');
    script.src = loaderUrl;
    script.onload = () => {
        statusEl.textContent = 'Loading assets…';
        createUnityInstance(canvas, config, (progress) => {
            const pct = Math.round(progress * 100);
            slider.value = pct;
            pctEl.textContent = pct + '%';
        }).then((instance) => {
            window.unityInstance = instance;

            // UNLOCK WEB AUDIO once per page load
            (function () {
                function resumeUnityAudio() {
                    try {
                        const m = window.unityInstance && window.unityInstance.Module;
                        // Unity 6 usually exposes the WebAudioContext here:
                        const ctx = m && (m.webAudioContext || m['webAudioContext']);
                        if (ctx && typeof ctx.resume === 'function' && ctx.state !== 'running') {
                            ctx.resume().catch(() => {});
                        }
                    } catch (e) { console.debug(e); }
                }
                // Resume on first user interaction (and when returning to the tab)
                window.addEventListener('pointerdown', resumeUnityAudio, { once: true });
                window.addEventListener('keydown', resumeUnityAudio, { once: true });
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) resumeUnityAudio();
                });
            })();
            // END UNLOCK

            // Hide HTML preloader, show the canvas when engine is ready.
            preload.style.display = 'none';
            canvas.style.display = 'block';
            statusEl.textContent = 'Ready';

        }).catch((msg) => {
            statusEl.textContent = 'Error loading';
            console.error(msg);
        });
    };
    document.body.appendChild(script);
</script>
</body>
</html>
